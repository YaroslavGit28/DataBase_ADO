# Руководство по отмене отдельных билетов

## Обзор

Теперь в системе CinemaBookingApp можно отменять отдельные билеты в бронировании, а не все бронирование целиком. Это позволяет пользователям более гибко управлять своими заказами.

## Как использовать

### 1. Открытие формы билетов

1. В главном окне перейдите на вкладку **"Бронирования"**
2. Выберите нужное бронирование в таблице
3. Нажмите кнопку **"Просмотр билетов"**

### 2. Выбор билетов для отмены

В открывшейся форме **"Билеты бронирования"** вы увидите:

- **Информацию о бронировании** (клиент, сумма, статус, дата)
- **Таблицу билетов** с колонкой "Выбрать"
- **Чекбокс "Выбрать все билеты"**
- **Кнопку "Отменить выбранные билеты"**

#### Варианты выбора:

**Вариант 1: Выбрать все билеты**
- Поставьте галочку в чекбокс **"Выбрать все билеты"**
- Все билеты будут автоматически выбраны

**Вариант 2: Выбрать отдельные билеты**
- Снимите галочку с **"Выбрать все билеты"** (если она была поставлена)
- Поставьте галочки только у нужных билетов в колонке **"Выбрать"**

**Вариант 3: Выбрать несколько билетов**
- Поставьте галочки у нескольких билетов (например, 1 или 2 из 5)

### 3. Отмена выбранных билетов

1. После выбора билетов нажмите кнопку **"Отменить выбранные билеты"**
2. Появится диалог подтверждения с количеством выбранных билетов
3. Нажмите **"Да"** для подтверждения отмены
4. Система выполнит отмену и покажет сообщение об успехе

## Что происходит при отмене

### Автоматические действия системы:

1. **Удаление билетов:** Выбранные билеты удаляются из базы данных
2. **Пересчет суммы:** Общая сумма бронирования пересчитывается автоматически
3. **Проверка бронирования:** Если все билеты отменены, бронирование автоматически получает статус "CANCELLED"
4. **Обновление интерфейса:** Форма обновляется с новыми данными

### Примеры сценариев:

#### Сценарий 1: Отмена 1 билета из 3
- **До:** Бронирование на 3 билета по 500 руб = 1500 руб
- **Отменяем:** 1 билет
- **После:** Бронирование на 2 билета по 500 руб = 1000 руб
- **Статус:** Остается активным

#### Сценарий 2: Отмена всех билетов
- **До:** Бронирование на 2 билета по 500 руб = 1000 руб
- **Отменяем:** Все 2 билета
- **После:** Бронирование без билетов = 0 руб
- **Статус:** Автоматически меняется на "CANCELLED"

#### Сценарий 3: Частичная отмена
- **До:** Бронирование на 5 билетов по 300 руб = 1500 руб
- **Отменяем:** 2 билета
- **После:** Бронирование на 3 билета по 300 руб = 900 руб
- **Статус:** Остается активным

## Технические детали

### Новые функции в коде:

#### DatabaseManager.cs
```csharp
// Отмена отдельных билетов
public void CancelTickets(int bookingId, List<int> ticketIds)

// Получение билетов по ID бронирования
public DataTable GetTicketsByBookingId(int bookingId)
```

#### TicketsForm.cs
- Добавлена колонка с чекбоксами для выбора билетов
- Добавлен чекбокс "Выбрать все"
- Добавлена кнопка "Отменить выбранные билеты"
- Реализована логика выбора и отмены билетов

### Безопасность операций:

- **Транзакции:** Все операции выполняются в транзакции для обеспечения целостности данных
- **Проверки:** Система проверяет корректность выбранных билетов
- **Подтверждение:** Обязательное подтверждение перед отменой
- **Откат:** При ошибке все изменения откатываются

## Ограничения и правила

### Кто может отменять билеты:
- **Администраторы:** Могут отменять любые билеты
- **Обычные пользователи:** Могут отменять только свои билеты (если реализовано)

### Когда можно отменять:
- **PENDING статус:** Можно отменять без ограничений
- **COMPLETED статус:** Можно отменять с возвратом средств
- **CANCELLED статус:** Нельзя отменять (уже отменено)

### Временные ограничения:
- Билеты можно отменять до начала сеанса
- После начала сеанса отмена может быть ограничена

## Уведомления и обратная связь

### Сообщения пользователю:

1. **Предупреждение:** "Выберите билеты для отмены" (если ничего не выбрано)
2. **Подтверждение:** "Вы уверены, что хотите отменить X билет(ов)?"
3. **Успех:** "Успешно отменено X билет(ов)"
4. **Ошибка:** "Ошибка при отмене билетов: [описание ошибки]"

### Обновление интерфейса:

- Форма билетов обновляется автоматически
- Главное окно обновляет список бронирований
- Изменения отражаются в реальном времени

## Примеры использования

### Пример 1: Семейное бронирование
```
Ситуация: Семья забронировала 4 билета, но один человек не может пойти
Решение: Отменить 1 билет, оставить 3
Результат: Экономия средств, места освобождаются для других
```

### Пример 2: Групповое бронирование
```
Ситуация: Компания забронировала 10 билетов, но 2 человека отменили участие
Решение: Отменить 2 билета, оставить 8
Результат: Группа все еще может пойти, но с меньшими затратами
```

### Пример 3: Полная отмена
```
Ситуация: Планы изменились, никто не может пойти
Решение: Отменить все билеты
Результат: Бронирование полностью отменено, все средства возвращены
```

## Советы по использованию

### Для пользователей:
1. **Проверяйте выбор:** Убедитесь, что выбрали правильные билеты
2. **Читайте подтверждения:** Внимательно читайте диалоги подтверждения
3. **Сохраняйте чеки:** Сохраняйте подтверждения об отмене
4. **Следите за временем:** Отменяйте билеты заранее

### Для администраторов:
1. **Проверяйте причины:** Выясняйте причины отмены для улучшения сервиса
2. **Мониторьте статистику:** Отслеживайте частоту отмен
3. **Обучайте пользователей:** Помогайте пользователям разобраться с функцией
4. **Документируйте случаи:** Ведите учет особых случаев отмены

## Заключение

Функция отмены отдельных билетов значительно повышает гибкость системы бронирования, позволяя пользователям:

- **Экономить средства** при частичной отмене
- **Освобождать места** для других посетителей
- **Управлять заказами** более точно
- **Адаптироваться** к изменяющимся планам

Система автоматически обрабатывает все технические аспекты, обеспечивая целостность данных и корректность расчетов.
